name: CI

on:
  workflow_dispatch:
  pull_request:

jobs:
  test-secret:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify secret access
        env:
          TEST_SECRET: ${{ secrets.TEST_SECRET }}
        run: |
          if [ -n "$TEST_SECRET" ]; then
            echo "✅ Secret successfully accessed"
            exit 0
          else
            echo "❌ Secret is empty or not set"
            exit 1
          fi

      - name: Set commit status
        if: always()
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATE="success"
          else
            STATE="failure"
          fi
          gh api \
            --method POST \
            /repos/${{ github.repository }}/statuses/${{ github.sha }} \
            -f state="$STATE" \
            -f target_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            -f description="CI check completed" \
            -f context="CI / test-secret"
